name: Build Without GStreamer

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-minimal:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install basic dependencies (no GStreamer)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libsdl2-dev \
          libgl1-mesa-dev \
          libegl1-mesa-dev \
          libopencv-dev \
          xvfb

    - name: Create minimal CMakeLists.txt
      working-directory: ./CameraApp
      run: |
        # Create a backup of original
        cp CMakeLists.txt CMakeLists.txt.backup
        
        # Create minimal version without GStreamer
        cat > CMakeLists.txt.minimal << 'EOF'
        cmake_minimum_required(VERSION 3.10)
        project(CameraApp)
        
        # Add build options
        option(SIMULATE_ALL_HARDWARE "Enable hardware simulation for development" OFF)
        option(DEBUG "Enable debug mode" OFF)
        
        if(SIMULATE_ALL_HARDWARE)
            add_compile_definitions(SIMULATE_ALL_HARDWARE)
            message(STATUS "Hardware simulation enabled")
        endif()
        
        if(DEBUG)
            add_compile_definitions(DEBUG)
            message(STATUS "Debug mode enabled")
        endif()
        
        # Enable C++17
        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)
        
        find_package(PkgConfig REQUIRED)
        
        # Find OpenGL
        message(STATUS "Using desktop OpenGL")
        find_package(OpenGL REQUIRED)
        add_compile_definitions(GL_SILENCE_DEPRECATION)
        
        # Find SDL2
        pkg_check_modules(SDL2 REQUIRED sdl2)
        
        # Find OpenCV  
        find_package(OpenCV REQUIRED)
        
        # Include directories
        set(PROJECT_INCLUDE_DIRS
            ${SDL2_INCLUDE_DIRS}
            ${OpenCV_INCLUDE_DIRS}
            ${CMAKE_CURRENT_SOURCE_DIR}/src
            ${CMAKE_CURRENT_SOURCE_DIR}/third_party/glad
            ${CMAKE_CURRENT_SOURCE_DIR}/third_party/imgui
            ${CMAKE_CURRENT_SOURCE_DIR}/third_party/imgui/backends
            ${CMAKE_CURRENT_SOURCE_DIR}/third_party/stb_image
        )
        
        # Minimal source files (just test a few core files)
        set(SRC_FILES
            src/main.cpp
            src/Window.cpp
            src/ErrorHandling/ErrorHandler.cpp
            third_party/imgui/imgui.cpp
            third_party/imgui/imgui_draw.cpp
            third_party/imgui/imgui_widgets.cpp
            third_party/imgui/imgui_tables.cpp
            third_party/imgui/backends/imgui_impl_sdl2.cpp
            third_party/imgui/backends/imgui_impl_opengl3.cpp
        )
        
        add_executable(CameraApp ${SRC_FILES})
        target_include_directories(CameraApp PRIVATE ${PROJECT_INCLUDE_DIRS})
        target_link_libraries(CameraApp ${OPENGL_LIBRARIES} ${SDL2_LIBRARIES} ${OpenCV_LIBS})
        
        # Enable high warning levels
        target_compile_options(CameraApp PRIVATE -Wall -Wextra -pedantic)
        EOF

    - name: Test minimal build
      working-directory: ./CameraApp
      env:
        DISPLAY: ":99"
      run: |
        # Start virtual display
        sudo Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
        mkdir -p build-minimal
        cd build-minimal
        
        echo "=== Testing with minimal CMakeLists.txt ==="
        cmake .. -f ../CMakeLists.txt.minimal -DSIMULATE_ALL_HARDWARE=ON
        
        echo "=== Building minimal version ==="
        make VERBOSE=1 -j2
        
        if [ -f "CameraApp" ]; then
          echo "✅ Minimal build successful!"
          ls -la CameraApp
        else
          echo "❌ Minimal build failed"
        fi

    - name: Upload minimal build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: minimal-build-attempt
        path: |
          CameraApp/build-minimal/
          CameraApp/CMakeLists.txt.backup
        retention-days: 7