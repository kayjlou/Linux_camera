name: Minimal Build Test

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  minimal-build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install essential build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake pkg-config

    - name: Install SDL2
      run: |
        sudo apt-get install -y libsdl2-dev
        pkg-config --exists sdl2 && echo "✅ SDL2 found" || echo "❌ SDL2 not found"
        pkg-config --cflags sdl2
        pkg-config --libs sdl2

    - name: Install OpenGL
      run: |
        sudo apt-get install -y libgl1-mesa-dev libegl1-mesa-dev
        ls /usr/include/GL/ || echo "No GL headers found"
        find /usr -name "libGL*" 2>/dev/null | head -5

    - name: Install GStreamer
      run: |
        sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
        pkg-config --exists gstreamer-1.0 && echo "✅ GStreamer found" || echo "❌ GStreamer not found"

    - name: Install OpenCV
      run: |
        sudo apt-get install -y libopencv-dev
        pkg-config --exists opencv4 && echo "✅ OpenCV4 found" || pkg-config --exists opencv && echo "✅ OpenCV found" || echo "❌ OpenCV not found"

    - name: Test CMake configure
      working-directory: ./CameraApp
      run: |
        echo "=== Project files ==="
        ls -la
        echo "=== Third party ==="
        ls -la third_party/
        echo "=== CMake configure ==="
        mkdir -p build-minimal
        cd build-minimal
        cmake .. -DSIMULATE_ALL_HARDWARE=ON -DDEBUG=ON

    - name: Test compilation (first few files)
      working-directory: ./CameraApp/build-minimal
      run: |
        echo "=== Make with verbose output (limited) ==="
        timeout 300 make VERBOSE=1 -j2 || echo "Build timed out or failed"
        
    - name: Check build results
      working-directory: ./CameraApp/build-minimal
      run: |
        echo "=== Build artifacts ==="
        ls -la
        if [ -f "CameraApp" ]; then
          echo "✅ Binary created!"
          file CameraApp
        else
          echo "❌ No binary found"
        fi