name: Simple Build Test

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  simple-build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug environment
      run: |
        echo "=== Environment Info ==="
        uname -a
        gcc --version
        cmake --version
        pkg-config --version

    - name: Install all dependencies
      run: |
        sudo apt-get update
        
        # Fix broken packages first
        sudo apt-mark unhold '*' || true
        sudo apt-get install -f
        
        # Install all required dependencies in one step
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          freeglut3-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libunwind-dev \
          libsdl2-dev \
          libopencv-dev

    - name: Check project structure
      run: |
        echo "=== Project Structure ==="
        find . -name "*.cpp" -o -name "*.h" | head -10
        echo "=== CMakeLists.txt exists? ==="
        ls -la CameraApp/CMakeLists.txt
        echo "=== Third party ==="
        ls -la CameraApp/third_party/

    - name: Try basic CMake configuration
      working-directory: ./CameraApp
      run: |
        mkdir -p build-simple
        cd build-simple
        echo "=== CMake configure without dependencies ==="
        cmake .. -DSIMULATE_ALL_HARDWARE=ON -DDEBUG=ON || echo "CMake failed - expected without deps"
        
    - name: Install OpenGL and SDL2
      run: |
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libegl1-mesa-dev \
          libsdl2-dev

    - name: Try CMake with basic deps
      working-directory: ./CameraApp
      run: |
        cd build-simple
        echo "=== CMake configure with basic deps ==="
        cmake .. -DSIMULATE_ALL_HARDWARE=ON -DDEBUG=ON || echo "Still failing - checking what's missing"

    - name: Install GStreamer
      run: |
        sudo apt-get install -y \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev

    - name: Install OpenCV
      run: |
        sudo apt-get install -y libopencv-dev

    - name: Final CMake attempt
      working-directory: ./CameraApp
      run: |
        cd build-simple
        echo "=== Final CMake configure ==="
        cmake .. -DSIMULATE_ALL_HARDWARE=ON -DDEBUG=ON
        
    - name: Build if CMake succeeded
      working-directory: ./CameraApp/build-simple
      run: |
        echo "=== Building ==="
        make -j2